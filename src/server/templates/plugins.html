{% extends "layout.html" %} {% block title %}{{ __('Plugins') }}{% endblock %} {% block head %}

<script src="./static/showdown-1.9.1/showdown.min.js"></script>

{% endblock %} {% block content %}
<script type="text/javascript" charset="utf-8">
	var data_dependencies = [
		'all_languages',
		'language',
		'plugin_list',
		'plugin_repo'
	];

	// set up markdown converter
	var converter = new showdown.Converter({
		ghCodeBlocks: true,
		ghCompatibleHeaderId: true,
		literalMidWordUnderscores: true,
		simpleLineBreaks: true,
		headerLevelStart: 4
	});

	$(document).ready(function () {
		socket.on('language', function (msg) {
			if (msg.language) {
				rotorhazard.interface_language = msg.language;
			}
		});

		socket.on('plugin_repo', function(msg) {
			rotorhazard.plugins.remote = msg.remote_data;
			display_plugin_list();
		})

		function display_plugin_list() {
			if (rotorhazard.plugins.remote) {
				console.log(rotorhazard.plugins.remote);

				var directory_top_el = $(document.createElement('ul'));

				for (var i in rotorhazard.plugins.remote) {
					var plugin = rotorhazard.plugins.remote[i];

					var plugin_el = $(document.createElement('li'))
						.addClass('plugin');

					// Main Info
					var main_info_el = $(document.createElement('div'))
						.addClass('main-info')
						.appendTo(plugin_el);

					$(document.createElement('h3'))
						.text(plugin.name)
						.appendTo(main_info_el);

					if (plugin.author) {
						var author_el = $(document.createElement('div'))
							.addClass('author')
							.appendTo(main_info_el);
						if (plugin.author_uri) {
							$(document.createElement('a'))
								.prop('href', plugin.author_uri)
								.text(plugin.author)
								.appendTo(author_el);
						} else {
							author_el.text(plugin.author);
						}
					}

					if(plugin.last_version) {
						$(document.createElement('div'))
							.addClass('version')
							.text(plugin.last_version)
							.appendTo(main_info_el);
					}

					if (plugin.repository) {
						var link_el = $(document.createElement('div'))
							.addClass('repository')
							.appendTo(details_el);
						$(document.createElement('a'))
							.prop('href', `https://github.com/${plugin.repository}`)
							.text(plugin.repository)
							.appendTo(main_info_el);
					}

					// Details
					var details_el = $(document.createElement('div'))
						.addClass('details')
						.appendTo(plugin_el);

					var description_el = $(document.createElement('div'))
						.addClass('description')
						.appendTo(details_el);
					if (plugin.description) {
						var md_output = converter.makeHtml(plugin.description);
						description_el.html(md_output);
					} else {
						description_el.text(__('not provided'));
					}

					if (plugin.info_uri) {
						var link_el = $(document.createElement('div'))
							.addClass('website')
							.appendTo(details_el);
						$(document.createElement('a'))
							.prop('href', plugin.info_uri)
							.text(__('website'))
							.appendTo(link_el);
					}

					if (plugin.license_uri) {
						var link_el = $(document.createElement('div'))
							.addClass('license')
							.appendTo(details_el);
						$(document.createElement('a'))
							.prop('href', plugin.license_uri)
							.text(__('license'))
							.appendTo(link_el);
					} else if (plugin.license) {
						$(document.createElement('div'))
							.addClass('license')
							.text(plugin.license)
							.appendTo(details_el);
					}

					// Status/Actions
					var status_el = $(document.createElement('div'))
						.addClass('status')
						.appendTo(plugin_el);

					var install_btn = $(document.createElement('button'))
							.addClass('install_plugin')
							.data('domain', plugin.domain)
							.text(__('Install'))
							.appendTo(status_el);

					if (plugin.update_status == 5) {
						install_btn.text(__('Reinstall'))
					} else if ([3, 4].includes(plugin.update_status)) {
						install_btn.text(__('Update'))
					}

					directory_top_el.append(plugin_el);
				}

				$('#plugin-list').empty()
					.append(directory_top_el);
			}
		}

		$(document).on('click', '.install_plugin', function (event) {
			var data = {
				method: 'domain',
				domain: $(this).data('domain'),
			};
			socket.emit('plugin_install', data);
		});

	});
</script>

<main class="page-plugins">

<div class="panel">
	<div class="panel-header">
		<h2>{{ __("Plugin Directory") }}</h2>
	</div>
	<div class="panel-content">
		<div id="plugin-list">
			<p>{{ __("Loading...") }}</p>
		</div>
	</div>
</div>

</main>
{% endblock %}